# Redis
레디스 설정과 이해

Redis란?

고성능 Key-Value 저장소로서 문자열, 리스트, 해시, 셋, 정렬된 셋 형식의 데이터를 지원하는 NoSql.

Memcached와 비슷한 캐시 시스템. 다양한 데이터 구조와 같은 부가적인 기능을 지원. 즉, 인메모리 데이터베이스

메모리에 저장하는 빠른 DB. 다양한 자료 구조.

다양한 자료구조를 지원 -> 개발의 편의성 up, 낮이도 down.

- 다양한 자료구조로 DBMS 처럼 DB에 저장하고 정렬하여 다시 가져오는 디스크 직접 접근 방식에 비해 시간이 빠름.

스프링 2.0 부터 Redis 사용 시 따로 bean 설정을 해주지 않아도 된다.

RedisTemplate에는 serializer 설정을 해주는데, 설정하지 않는다면 직접 redis-cli로 데이터 확인이 어려움.



-----

Redis는 메인 Key에만 설정할 수 있는 명령어가 있다. -> TTL(Time to Live)

일정 기간만 저장하고 싶을 때 TTL을 사용

-> 캐쉬의 복잡성과 자료의 관리를 보다 쉽게할 수 있지 않을까? 자바의 가비지 콜렉터같이?
   -> Redis의 expriation은 active와 passive 방식으로 나눠진다.
      active는 client가 만료된 데이터에 접근할 때 체크하고 지우는 방식
         passive는 일정 시간마다 100개(대략)의 데이터만 스캔해서 지우는 방식
       -> 모든 expired된 데이터들을 지우는 것이 아니기 때문에 garbage data들은 여전히 존재한다....


-----

해쉬 저장 방식

사용자 정보를 저장하는 hash의 키가 user:1001 이라고 가정했을때,

HSET user:1234 이름 "John Doe"
HSET user:1234 나이 25
HSET user:1234 이메일 "john.doe@example.com"

HGET user:1234 이름

으로 가져올 수 있다.

인덱스 방식이 아닌 hash의 키를 가지고 직접 조회하기 때문에

특정한 경우가 아닌 이상 상수에 가까운 시간 복잡도를 가진다.

-----

RDBMS와 Redis를 같이 사용한다면 복잡성이 증가하여 개발자의 이해가 뒷받침되어야 한다.

같이 사용하여 데이터을 관리하는 것은 성능상 효율은 가져올 수 있으나

데이터들을 다루면서 RDBMS와 Redis의 데이터의 불일치를 경계해야한다.

트랜잭션 처리등을 통해서 데이터들의 일치를 이루어야 할 것이다.


------

그러면 데이터들을 CRUD 하면서 어떤 식으로 일치시키는 것이 좋을까?

여러개의 Repository를 사용하여 여러번의 save, 또는 find
-> 코드는 간결해진다. 하지만 개발자의 실수가 있을 때는 데이터의 불일치가 일어날 가능성도 있다.


하나의 repository에서 redis까지 포함한 데이터의 일치
-> 코드는 조금 늘어날 수 있다. 하지만 개발자의 실수가 없도록 예방할 수 있으나, 여러개의 엔티티들을 작업하면 그만큼 코드의 복잡성은 늘어날 것이다.


------

Redis는 디스크 저장 방식을 사용하기 때문에 서버가 다운되더라도 데이터의 손실이 일어나지 않는다.

memcached의 경우 메모리에만 데이터를 저장해놓기 때문에 서버가 다운된다면 데이터는 모두 날아간다.

Redis의 데이터 저장방식은 크게 두가지

1. Snapshotting(RDB)

순간적으로 redis의 모든 동작을 정지시키고 데이터들을 disk에 저장한다.

서버가 다운되더라도 disk에 저장되어 있는 데이터들을 가지고 restart하기 때문에 재시작이 빠르다.

하지만 snapshot을 추출하는 과정이 시간이 오래 걸릴 수 있다. 그리고 lastest snapshot 이후의 데이터들은 손실된다.

2. AOF(Append on file)

redis의 모든 write/update 의 연산들을 log에 기록해놓는 방식이다.

재시작시 log에있는 모든 연산들을 재연산 하기 때문에 데이터들의 손실이 없다.

하지만 모든 연산들이 log에 기록되기 때문에 log의 양이 너무 많아서 재시작 시에 시간이 오래 걸릴 수 있다.

-> 두개의 방식을 합쳐서 사용하면 좋을 것이다. 어느 정도까지는 snapshotting 방식을 사용하여 snapshot 추출 후, 다음 snapshot 까지는 AOF방식으로 로그를 기록해 놓는다면
    데이터들의 손실을 보다 효과적으로 보장할 수 있을 것이다.


-----

Redis를 이용한 동시 접속자 수 처리속도, 성능 향상

Redis는 master/slave duplicate가 가능하다. 심지어 redis를 사용하고 있는 와중에도 백그라운드에선 복제가 일어나고 있다.

이것을 이용해 어떤 성능을 향상시킬 수 있을 것인가?

보통 서버에 들어오는 write 요청이 10~20%, read가 70~90%이기 때문에 read 트랜젝션을 로드벨런싱 한다면?

서버에 오는 과부하를 줄이고 보다 효과적인 성능을 기대해볼 수 있을 것이다.
